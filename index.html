<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cotizacion - Foto Shop Estudio</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:#f5f6f8;color:#1a1a1a;min-height:100vh}
.wrap{max-width:800px;margin:0 auto;padding:32px 20px}
.card{background:#fff;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.08);overflow:hidden}
.head{padding:28px 32px;display:flex;justify-content:space-between;align-items:flex-start;border-bottom:3px solid #0099CC}
.head-l img{max-height:50px}
.head-r{text-align:right}
.head-r .estado{display:inline-block;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.estado-enviada{background:#e8f4fd;color:#0099CC}
.estado-aceptada{background:#e6f9ef;color:#00a854}
.estado-rechazada{background:#fde8e8;color:#d33}
.head-r .num{font-size:20px;font-weight:700;color:#1a1a1a;margin-top:4px}
.head-r .fecha{font-size:13px;color:#888}
.body{padding:28px 32px}
.cols{display:flex;gap:32px;margin-bottom:24px}
.col{flex:1}
.col-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#999;font-weight:600;margin-bottom:6px}
.col-name{font-size:15px;font-weight:600;color:#222}
.col-info{font-size:13px;color:#666;margin-top:2px}
table{width:100%;border-collapse:collapse;margin:16px 0}
thead th{background:#f7f8fa;padding:10px 12px;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:#777;font-weight:600;text-align:left}
thead th.r{text-align:right}
thead th.c{text-align:center}
tbody td{padding:10px 12px;font-size:13px;border-bottom:1px solid #f0f0f0;color:#444}
tbody td.prod{font-weight:600;color:#222}
tbody td.r{text-align:right}
tbody td.c{text-align:center}
tbody tr:last-child td{border-bottom:none}
.totals{display:flex;justify-content:flex-end;margin-top:8px}
.totals-box{width:240px}
.tot-row{display:flex;justify-content:space-between;padding:5px 0;font-size:13px;color:#666}
.tot-total{display:flex;justify-content:space-between;padding:8px 0;font-size:17px;font-weight:700;color:#1a1a1a;border-top:2px solid #0099CC;margin-top:4px}
.notas{margin-top:20px;padding:16px;background:#fafbfc;border-radius:8px;border:1px solid #eee}
.notas-t{font-size:12px;font-weight:700;color:#555;margin-bottom:6px}
.notas-i{font-size:12px;color:#666;margin-bottom:2px}
.pago{margin-top:20px}
.pago-t{font-size:12px;font-weight:700;color:#555;margin-bottom:8px}
.pago-row{display:flex;justify-content:space-between;padding:10px 14px;background:#f7f8fa;border-radius:6px;font-size:13px}
.btns{display:flex;justify-content:center;gap:20px;padding:28px 32px;border-top:1px solid #f0f0f0}
.btn{padding:14px 48px;border-radius:30px;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;border:2px solid;transition:all .2s;text-transform:uppercase;letter-spacing:1px}
.btn-a{border-color:#64b450;color:#64b450;background:#fff}
.btn-a:hover{background:#64b450;color:#fff}
.btn-r{border-color:#dc4640;color:#dc4640;background:#fff}
.btn-r:hover{background:#dc4640;color:#fff}
.btn:disabled{opacity:.5;cursor:not-allowed}
.msg{text-align:center;padding:24px;font-size:15px;font-weight:600}
.msg-ok{color:#00a854}
.msg-no{color:#dc4640}
.loading{text-align:center;padding:80px 20px;color:#888;font-size:15px}
.respondida{text-align:center;padding:20px 32px 28px;font-size:14px;color:#666}
.respondida b{font-size:16px}
@media(max-width:600px){
  .head{flex-direction:column;gap:12px;padding:20px}
  .head-r{text-align:left}
  .cols{flex-direction:column;gap:16px}
  .body{padding:20px}
  .btns{flex-direction:column;padding:20px}
  .btn{width:100%;text-align:center}
}
</style>
</head>
<body>
<div class="wrap">
  <div id="loading" class="loading">Cargando cotizaci&#243;n...</div>
  <div id="content" style="display:none">
    <div class="card">
      <div class="head">
        <div class="head-l"><img src="https://maxblanchardf.github.io/cotizador-fse/logo.png" alt="Foto Shop Estudio" onerror="this.outerHTML='<div style=font-size:22px;font-weight:800;color:#0099CC>FOTO SHOP<br><span style=font-size:13px;color:#777;font-weight:400;letter-spacing:3px>E S T U D I O</span></div>'"></div>
        <div class="head-r">
          <span class="estado" id="estado"></span>
          <div class="num" id="num"></div>
          <div class="fecha" id="fecha"></div>
        </div>
      </div>
      <div class="body">
        <div class="cols">
          <div class="col">
            <div class="col-label">De</div>
            <div class="col-name">Foto Shop Estudio</div>
            <div class="col-info">+569 9330 6411 | max@fotoshopestudio.cl</div>
          </div>
          <div class="col">
            <div class="col-label">Cliente</div>
            <div class="col-name" id="empresa"></div>
            <div class="col-info" id="contacto"></div>
            <div class="col-info" id="email_tel"></div>
          </div>
        </div>
        <div id="desc_box" style="display:none;margin-bottom:16px">
          <div style="font-size:13px;color:#555;padding:8px 0;border-top:1px solid #eee" id="desc_text"></div>
        </div>
        <table>
          <thead><tr><th>Producto</th><th>Descripci&#243;n</th><th class="r">Precio</th><th class="c">Cant.</th><th class="c">Imp.</th><th class="r">Importe</th></tr></thead>
          <tbody id="items_body"></tbody>
        </table>
        <div class="totals"><div class="totals-box">
          <div class="tot-row"><span>Subtotal</span><span id="subtotal"></span></div>
          <div class="tot-row"><span>IVA 19%</span><span id="iva"></span></div>
          <div class="tot-total"><span>Total</span><span id="total"></span></div>
        </div></div>
        <div id="notas_box" style="display:none" class="notas">
          <div class="notas-t">NOTAS</div>
          <div id="notas_list"></div>
        </div>
        <div id="pago_box" style="display:none" class="pago">
          <div class="pago-t">PROGRAMACI&#211;N DE PAGO</div>
          <div class="pago-row"><span>Vence el: <b id="vence"></b></span><span><b id="pago_monto"></b></span></div>
        </div>
      </div>
      <div id="btns" class="btns" style="display:none">
        <button class="btn btn-a" onclick="responder('aceptar')">&#10003; Aceptar Cotizaci&#243;n</button>
        <button class="btn btn-r" onclick="responder('rechazar')">&#10005; Rechazar</button>
      </div>
      <div id="msg" style="display:none"></div>
    </div>
    <div style="text-align:center;padding:20px;font-size:11px;color:#bbb">Foto Shop Estudio &#183; La Puntilla 15740, Lo Barnechea &#183; +569 9330 6411</div>
  </div>
  <div id="error" style="display:none;text-align:center;padding:80px 20px">
    <div style="font-size:48px;margin-bottom:16px">&#128196;</div>
    <div style="font-size:18px;font-weight:600;color:#333;margin-bottom:8px">Cotizaci&#243;n no encontrada</div>
    <div style="font-size:14px;color:#888">El enlace puede estar incorrecto o la cotizaci&#243;n ya no est&#225; disponible.</div>
  </div>
</div>

<script>
const PROXY='https://script.google.com/macros/s/AKfycby3UlNmGoJ4ccqPRm-lDmmxN3_DJNXNxgUBbmZXLDXuoIkz9m5A7O3F_R2R8hl1rZtr9A/exec';
const params=new URLSearchParams(location.search);
const NUM=params.get('num')||'';

function $(id){return document.getElementById(id)}
function fCLP(n){return '$'+Math.round(Number(n)||0).toLocaleString('es-CL')}

function jsonp(url){
  return new Promise((ok,fail)=>{
    const cb='cb_'+Date.now()+'_'+Math.random().toString(36).slice(2);
    const t=setTimeout(()=>{delete window[cb];fail('Timeout')},15000);
    window[cb]=function(d){clearTimeout(t);delete window[cb];ok(d)};
    const s=document.createElement('script');
    s.src=url+'&callback='+cb;
    s.onerror=()=>{clearTimeout(t);delete window[cb];fail('Error')};
    document.head.appendChild(s);
    s.onload=()=>s.remove();
  });
}

async function load(){
  if(!NUM){showError();return}
  try{
    const r=await jsonp(PROXY+'?action=ver_cotizacion&num='+encodeURIComponent(NUM));
    if(!r||!r.ok||!r.cotizacion){showError();return}
    render(r.cotizacion);
  }catch(e){console.error(e);showError()}
}

function showError(){
  $('loading').style.display='none';
  $('error').style.display='block';
}

function render(c){
  $('loading').style.display='none';
  $('content').style.display='block';
  
  // Estado
  const est=c.estado||'Enviada';
  $('estado').textContent=est;
  $('estado').className='estado estado-'+est.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  
  // Header
  $('num').innerHTML='Cotizaci&#243;n '+c.numero;
  $('fecha').textContent=c.fecha_emision?'Emitida el '+c.fecha_emision:'';
  
  // Cliente
  $('empresa').textContent=c.empresa||'&#8212;';
  $('contacto').textContent=c.contacto||'';
  const parts=[];
  if(c.email)parts.push(c.email);
  if(c.telefono)parts.push(c.telefono);
  $('email_tel').textContent=parts.join(' | ');
  
  // Descripci&#243;n
  if(c.descripcion){
    $('desc_box').style.display='block';
    $('desc_text').textContent=c.descripcion;
  }
  
  // Items del detalle (parseando del update body)
  const tbody=$('items_body');
  if(c.detalle){
    const lines=c.detalle.replace(/<[^>]+>/g,'').split('\n').filter(l=>l.trim()&&!l.includes('Detalle'));
    lines.forEach(line=>{
      const parts=line.trim().split(' x');
      if(parts.length>=2){
        const prod=parts[0].trim();
        const rest=parts.slice(1).join(' x').trim();
        const eqParts=rest.split('=');
        const qty=eqParts[0].trim();
        const imp=eqParts[1]?eqParts[1].trim():'';
        const tr=document.createElement('tr');
        tr.innerHTML='<td class="prod">'+prod+'</td><td></td><td class="r"></td><td class="c">'+qty+'</td><td class="c">19%</td><td class="r">'+imp+'</td>';
        tbody.appendChild(tr);
      }
    });
  }
  
  // Totales
  $('subtotal').textContent=fCLP(c.subtotal);
  $('iva').textContent=fCLP(c.iva);
  $('total').textContent=fCLP(c.total);
  
  // Notas
  if(c.notas){
    $('notas_box').style.display='block';
    const nl=$('notas_list');
    c.notas.split('\n').forEach(n=>{
      if(n.trim()){
        const d=document.createElement('div');
        d.className='notas-i';
        d.textContent=n.startsWith('-')?n:'- '+n;
        nl.appendChild(d);
      }
    });
  }
  
  // Pago
  if(c.fecha_vencimiento){
    $('pago_box').style.display='block';
    $('vence').textContent=c.fecha_vencimiento;
    $('pago_monto').textContent=fCLP(c.total);
  }
  
  // Botones solo si est&#225; pendiente/enviada
  const estLow=est.toLowerCase();
  if(estLow==='enviada'||estLow==='pendiente'||estLow===''){
    $('btns').style.display='flex';
  }else{
    $('msg').style.display='block';
    if(estLow.includes('aceptada')){
      $('msg').innerHTML='<div class="respondida"><b class="msg-ok">&#10003; Cotizaci&#243;n Aceptada</b><br>Gracias por tu confianza. Nos pondremos en contacto para coordinar.</div>';
    }else{
      $('msg').innerHTML='<div class="respondida"><b class="msg-no">&#10005; Cotizaci&#243;n Rechazada</b><br>Gracias por tu tiempo. Quedamos atentos para futuras oportunidades.</div>';
    }
  }
}

async function responder(tipo){
  const btns=document.querySelectorAll('.btn');
  btns.forEach(b=>b.disabled=true);
  btns.forEach(b=>b.textContent='Procesando...');
  try{
    const r=await jsonp(PROXY+'?action=responder&num='+encodeURIComponent(NUM)+'&resp='+tipo);
    $('btns').style.display='none';
    $('msg').style.display='block';
    if(tipo==='aceptar'){
      $('msg').innerHTML='<div class="respondida"><b class="msg-ok">&#10003; &#161;Cotizaci&#243;n Aceptada!</b><br>Gracias por tu confianza. Nos pondremos en contacto para coordinar los pr&#243;ximos pasos.</div>';
      $('estado').textContent='Aceptada';
      $('estado').className='estado estado-aceptada';
    }else{
      $('msg').innerHTML='<div class="respondida"><b class="msg-no">&#10005; Cotizaci&#243;n Rechazada</b><br>Gracias por tu tiempo. Quedamos atentos para futuras oportunidades.</div>';
      $('estado').textContent='Rechazada';
      $('estado').className='estado estado-rechazada';
    }
  }catch(e){
    console.error(e);
    btns.forEach(b=>b.disabled=false);
    btns[0].innerHTML='&#10003; Aceptar Cotizaci&#243;n';
    btns[1].innerHTML='&#10005; Rechazar';
    alert('Error al procesar. Intenta de nuevo.');
  }
}

load();
</script>
</body>
</html>
